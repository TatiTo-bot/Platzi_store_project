{% extends 'products/base.html' %}

{% block title %}{{ product.title }} - Platzi Store{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="mb-3">
            <a href="{% url 'products:products' %}" class="btn btn-outline-light">
                <i class="fas fa-arrow-left"></i> Volver a productos
            </a>
        </div>
        
        <div class="card">
            <div class="row g-0">
                <div class="col-md-5">
                    {% if product.images and product.images.0 %}
                        <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                {% for image in product.images %}
                                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                        <img src="{{ image }}" class="d-block w-100" style="height: 400px; object-fit: cover; border-radius: 15px 0 0 15px;" alt="{{ product.title }}">
                                    </div>
                                {% endfor %}
                            </div>
                            {% if product.images|length > 1 %}
                                <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="bg-light d-flex align-items-center justify-content-center" style="height: 400px; border-radius: 15px 0 0 15px;">
                            <i class="fas fa-image fa-5x text-muted"></i>
                        </div>
                    {% endif %}
                </div>
                
                <div class="col-md-7">
                    <div class="card-body h-100 d-flex flex-column">
                        <div class="mb-3">
                            {% if product.category %}
                                <span class="badge bg-primary mb-2">{{ product.category.name }}</span>
                            {% endif %}
                            <h1 class="card-title">{{ product.title }}</h1>
                        </div>
                        
                        <div class="mb-4">
                            <h2 class="text-primary">${{ product.price }}</h2>
                        </div>
                        
                        <div class="mb-4 flex-grow-1">
                            <h5>Descripción</h5>
                            <p class="text-muted">{{ product.description }}</p>
                        </div>
                        
                        <div class="product-info mb-4">
                            <h6>Información del producto</h6>
                            <ul class="list-unstyled">
                                <li><strong>ID:</strong> {{ product.id }}</li>
                                <li><strong>Categoría:</strong> 
                                    {% if product.category %}
                                        {{ product.category.name }} (ID: {{ product.category.id }})
                                    {% else %}
                                        No especificada
                                    {% endif %}
                                </li>
                                <li><strong>Imágenes:</strong> {{ product.images|length }} disponible(s)</li>
                            </ul>
                        </div>
                        
                        <!-- Botones de acción solo para usuarios autenticados -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <!-- Botón Editar - solo usuarios autenticados -->
                            <a href="{% url 'products:edit_product' product.id %}" class="btn btn-warning me-md-2 auth-required" style="display: none;">
                                <i class="fas fa-edit"></i> Editar Producto
                            </a>
                            <!-- Botón Eliminar - solo usuarios autenticados -->
                            <button class="btn btn-danger auth-required" onclick="deleteProduct({{ product.id }}, '{{ product.title }}')" style="display: none;">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </div>
                        
                        <!-- Mensaje para usuarios no autenticados -->
                        <div id="authMessage" class="alert alert-info mt-3" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>¿Quieres gestionar este producto?</strong>
                            <br>
                            <a href="{% url 'accounts:login' %}" class="btn btn-primary btn-sm mt-2 me-2">
                                <i class="fas fa-sign-in-alt"></i> Iniciar sesión
                            </a>
                            <a href="{% url 'accounts:register' %}" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="fas fa-user-plus"></i> Registrarse
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Card adicional con más información del producto -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Detalles Técnicos
                        </h5>
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <td><strong>ID del Producto:</strong></td>
                                    <td>{{ product.id }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Precio:</strong></td>
                                    <td class="text-success">${{ product.price }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Categoría ID:</strong></td>
                                    <td>{{ product.category.id|default:"N/A" }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Total de Imágenes:</strong></td>
                                    <td>{{ product.images|length }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-images text-primary me-2"></i>
                            Galería de Imágenes
                        </h5>
                        {% if product.images %}
                            <div class="row">
                                {% for image in product.images %}
                                    <div class="col-4 mb-2">
                                        <img src="{{ image }}" class="img-thumbnail" style="height: 80px; width: 100%; object-fit: cover;" alt="Imagen {{ forloop.counter }}" onclick="showImageModal('{{ image }}', '{{ product.title }} - Imagen {{ forloop.counter }}')">
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">
                                <i class="fas fa-image me-2"></i>
                                No hay imágenes disponibles para este producto.
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar imagen en grande -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageModalTitle">Imagen del Producto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid" alt="Imagen del producto">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Verificar estado de autenticación cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    checkAuthStatusForProductDetail();
});

// Función específica para product_detail
function checkAuthStatusForProductDetail() {
    const token = localStorage.getItem('authToken');
    
    if (token) {
        // Verificar que el token sea válido
        fetch('/accounts/api/profile/', {
            headers: {
                'Authorization': `Token ${token}`
            }
        }).then(response => {
            if (response.ok) {
                // Usuario autenticado - mostrar botones de editar/eliminar
                showProductDetailAuthElements();
            } else {
                // Token inválido - mostrar mensaje de login
                hideProductDetailAuthElements();
            }
        }).catch(error => {
            // Error de conexión - mostrar mensaje de login
            hideProductDetailAuthElements();
        });
    } else {
        // No hay token - mostrar mensaje de login
        hideProductDetailAuthElements();
    }
}

function showProductDetailAuthElements() {
    // Mostrar botones de editar/eliminar
    document.querySelectorAll('.auth-required').forEach(element => {
        element.style.display = element.classList.contains('btn') ? 'inline-block' : 'block';
    });
    
    // Ocultar mensaje de autenticación
    const authMessage = document.getElementById('authMessage');
    if (authMessage) {
        authMessage.style.display = 'none';
    }
}

function hideProductDetailAuthElements() {
    // Ocultar botones de editar/eliminar
    document.querySelectorAll('.auth-required').forEach(element => {
        element.style.display = 'none';
    });
    
    // Mostrar mensaje de autenticación
    const authMessage = document.getElementById('authMessage');
    if (authMessage) {
        authMessage.style.display = 'block';
    }
}

function deleteProduct(productId, productTitle) {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        Swal.fire({
            title: 'Autenticación requerida',
            text: 'Debes iniciar sesión para eliminar productos',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Iniciar sesión',
            cancelButtonText: 'Cancelar',
            confirmButtonColor: '#007bff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '{% url "accounts:login" %}';
            }
        });
        return;
    }

    Swal.fire({
        title: '¿Estás seguro?',
        text: `¿Deseas eliminar el producto "${productTitle}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/products/${productId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Token ${token}`,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire(
                        '¡Eliminado!',
                        data.message,
                        'success'
                    ).then(() => {
                        window.location.href = '/products/';
                    });
                } else {
                    Swal.fire(
                        'Error',
                        data.message || 'Error al eliminar el producto',
                        'error'
                    );
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire(
                    'Error',
                    'Ocurrió un error al eliminar el producto',
                    'error'
                );
            });
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Función para mostrar imagen en modal
function showImageModal(imageSrc, imageTitle) {
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    document.getElementById('modalImage').src = imageSrc;
    document.getElementById('imageModalTitle').textContent = imageTitle;
    modal.show();
}

// Actualizar estado de autenticación cuando cambie el localStorage
window.addEventListener('storage', function(e) {
    if (e.key === 'authToken') {
        checkAuthStatusForProductDetail();
    }
});

// Animaciones adicionales para mejorar la UX
document.addEventListener('DOMContentLoaded', function() {
    // Efecto hover en las imágenes en miniatura
    document.querySelectorAll('.img-thumbnail').forEach(img => {
        img.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.1)';
            this.style.transition = 'all 0.3s ease';
            this.style.cursor = 'pointer';
        });
        
        img.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
        });
    });
    
    // Efectos en las cards
    document.querySelectorAll('.card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
    
    // Lazy loading para imágenes del carousel
    const carouselImages = document.querySelectorAll('#productCarousel img');
    if (carouselImages.length > 0) {
        carouselImages.forEach(img => {
            img.addEventListener('load', function() {
                this.style.opacity = '0';
                this.style.transition = 'opacity 0.3s ease';
                setTimeout(() => {
                    this.style.opacity = '1';
                }, 100);
            });
        });
    }
});
</script>
{% endblock %}